<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="eJedzie.pl" />
    <meta name="theme-color" content="#3b82f6" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <title>Czy ulica stoi? - Spo≈Çeczno≈õciowe raporty ruchu</title>
    <meta name="description" content="Sprawd≈∫ aktualny stan ruchu na ulicach w Twojej okolicy. Spo≈Çeczno≈õciowa aplikacja do raportowania kork√≥w i p≈Çynno≈õci ruchu." />
    <meta name="author" content="Lovable" />

    <meta property="og:title" content="Czy ulica stoi? - Raporty ruchu" />
    <meta property="og:description" content="Spo≈Çeczno≈õciowa aplikacja do sprawdzania stanu ruchu na ulicach" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H86458DTN6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-H86458DTN6');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2442601232836054"
     crossorigin="anonymous"></script>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      console.log('[OneSignal] ==================== ONESIGNAL SDK INITIALIZING ====================');
      console.log('[OneSignal] Timestamp:', new Date().toISOString());

      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        console.log('[OneSignal] OneSignal callback executed - starting initialization...');

        try {
          await OneSignal.init({
            appId: "16ce973c-c7b3-42ff-b7b4-fe48be517186",
            serviceWorkerParam: { scope: '/' },
            serviceWorkerPath: '/OneSignalSDKWorker.js',
            notifyButton: { enable: false },
            allowLocalhostAsSecureOrigin: true,
            promptOptions: {
              slidedown: {
                prompts: [
                  {
                    type: "push",
                    autoPrompt: false,
                    text: {
                      actionMessage: "Chcesz otrzymywaƒá powiadomienia o korkach na Twojej ulicy?",
                      acceptButton: "Tak, w≈ÇƒÖcz",
                      cancelButton: "Nie teraz"
                    }
                  }
                ]
              }
            }
          });

          console.log('[OneSignal] ‚úÖ OneSignal initialized successfully');
          console.log('[OneSignal] App ID:', '16ce973c-c7b3-42ff-b7b4-fe48be517186');
          console.log('[OneSignal] Service Worker Path:', '/OneSignalSDKWorker.js');

          // CRITICAL: Add listener for foreground notifications
          OneSignal.Notifications.addEventListener('foregroundWillDisplay', async (event) => {
            console.log('');
            console.log('üîî [OneSignal-Notification] ==================== FOREGROUND NOTIFICATION ====================');
            console.log('[OneSignal-Notification] Timestamp:', new Date().toISOString());
            console.log('[OneSignal-Notification] foregroundWillDisplay event triggered!');
            console.log('[OneSignal-Notification] Event:', event);
            console.log('[OneSignal-Notification] Notification object:', event.notification);

            if (event.notification) {
              console.log('[OneSignal-Notification] Title:', event.notification.title);
              console.log('[OneSignal-Notification] Body:', event.notification.body);
              console.log('[OneSignal-Notification] Data:', event.notification.data);
              console.log('[OneSignal-Notification] Launch URL:', event.notification.launchURL);
            }

            // Prevent default to manually control display
            event.preventDefault();
            console.log('[OneSignal-Notification] ‚ö†Ô∏è Default prevented - will display manually');

            // Manually display the notification
            try {
              event.notification.display();
              console.log('[OneSignal-Notification] ‚úÖ Notification displayed manually');
            } catch (displayError) {
              console.error('[OneSignal-Notification] ‚ùå Error displaying notification:', displayError);
            }

            console.log('[OneSignal-Notification] ================================================================');
            console.log('');
          });

          console.log('[OneSignal] ‚úÖ foregroundWillDisplay event listener registered');

          // Log subscription changes
          OneSignal.User.PushSubscription.addEventListener('change', (event) => {
            console.log('');
            console.log('üîÑ [OneSignal-Subscription] ==================== SUBSCRIPTION CHANGED ====================');
            console.log('[OneSignal-Subscription] Timestamp:', new Date().toISOString());
            console.log('[OneSignal-Subscription] Previous state:', event.previous);
            console.log('[OneSignal-Subscription] Current state:', event.current);

            if (event.current) {
              console.log('[OneSignal-Subscription] Opted In:', event.current.optedIn);
              console.log('[OneSignal-Subscription] ID:', event.current.id);
              console.log('[OneSignal-Subscription] Token:', event.current.token ? event.current.token.substring(0, 50) + '...' : null);
            }

            console.log('[OneSignal-Subscription] ================================================================');
            console.log('');
          });

          console.log('[OneSignal] ‚úÖ Subscription change event listener registered');

          // Log permission changes
          OneSignal.Notifications.addEventListener('permissionChange', (permission) => {
            console.log('');
            console.log('üîê [OneSignal-Permission] ==================== PERMISSION CHANGED ====================');
            console.log('[OneSignal-Permission] Timestamp:', new Date().toISOString());
            console.log('[OneSignal-Permission] New permission:', permission);
            console.log('[OneSignal-Permission] Permission granted:', permission === true || permission === 'granted');
            console.log('[OneSignal-Permission] ================================================================');
            console.log('');
          });

          console.log('[OneSignal] ‚úÖ Permission change event listener registered');

          // Log notification clicks
          OneSignal.Notifications.addEventListener('click', (event) => {
            console.log('');
            console.log('üëÜ [OneSignal-Click] ==================== NOTIFICATION CLICKED ====================');
            console.log('[OneSignal-Click] Timestamp:', new Date().toISOString());
            console.log('[OneSignal-Click] Notification:', event.notification);

            if (event.notification) {
              console.log('[OneSignal-Click] Title:', event.notification.title);
              console.log('[OneSignal-Click] Body:', event.notification.body);
              console.log('[OneSignal-Click] Data:', event.notification.data);
              console.log('[OneSignal-Click] Launch URL:', event.notification.launchURL);
            }

            console.log('[OneSignal-Click] ================================================================');
            console.log('');
          });

          console.log('[OneSignal] ‚úÖ Notification click event listener registered');

          console.log('[OneSignal] ==================== INITIALIZATION COMPLETE ====================');
          console.log('[OneSignal] All event listeners registered successfully');
          console.log('[OneSignal] - foregroundWillDisplay (with manual display)');
          console.log('[OneSignal] - subscription change');
          console.log('[OneSignal] - permission change');
          console.log('[OneSignal] - notification click');
          console.log('[OneSignal] ================================================================');

          // Check if user is not subscribed and show slidedown prompt
          console.log('[OneSignal] Checking subscription status for auto-prompt...');

          const permission = Notification.permission;
          const isOptedIn = OneSignal.User.PushSubscription.optedIn;

          console.log('[OneSignal] Browser permission:', permission);
          console.log('[OneSignal] OneSignal optedIn:', isOptedIn);

          // Show slidedown if user hasn't granted permission or isn't opted in
          if (permission === 'default' || (permission === 'granted' && !isOptedIn)) {
            console.log('[OneSignal] User not subscribed - showing slidedown prompt...');
            try {
              await OneSignal.Slidedown.promptPush();
              console.log('[OneSignal] ‚úÖ Slidedown prompt displayed');
            } catch (promptError) {
              console.log('[OneSignal] Slidedown prompt error (may be dismissed previously):', promptError.message);
            }
          } else if (permission === 'denied') {
            console.log('[OneSignal] User has blocked notifications - cannot show prompt');
          } else {
            console.log('[OneSignal] User already subscribed - no prompt needed');
          }

        } catch (error) {
          console.error('‚ùå [OneSignal] Initialization error:', error);
          console.error('[OneSignal] Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack
          });
        }
      });

      console.log('[OneSignal] OneSignal initialization callback queued');
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
