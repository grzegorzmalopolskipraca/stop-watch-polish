<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="eJedzie.pl" />
    <meta name="theme-color" content="#3b82f6" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <title>Czy ulica stoi? - Spo≈Çeczno≈õciowe raporty ruchu</title>
    <meta name="description" content="Sprawd≈∫ aktualny stan ruchu na ulicach w Twojej okolicy. Spo≈Çeczno≈õciowa aplikacja do raportowania kork√≥w i p≈Çynno≈õci ruchu." />
    <meta name="author" content="Lovable" />

    <meta property="og:title" content="Czy ulica stoi? - Raporty ruchu" />
    <meta property="og:description" content="Spo≈Çeczno≈õciowa aplikacja do sprawdzania stanu ruchu na ulicach" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H86458DTN6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-H86458DTN6');
    </script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2442601232836054"
     crossorigin="anonymous"></script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      // Proactive cleanup of legacy/non-OneSignal service workers (sw.js, wonderpush, vite-pwa)
      (function () {
        if (!('serviceWorker' in navigator)) return;
        console.log('[SW Cleanup] Checking existing service workers...');
        navigator.serviceWorker.getRegistrations().then(async (regs) => {
          console.log('[SW Cleanup] Registrations:', regs.map(r => ({
            scope: r.scope,
            script: (r.active?.scriptURL || r.installing?.scriptURL || r.waiting?.scriptURL || '<unknown>')
          })));
          let removed = false;
          for (const r of regs) {
            const script = r.active?.scriptURL || r.installing?.scriptURL || r.waiting?.scriptURL || '';
            const isOneSignal = /OneSignalSDKWorker\.js|OneSignalSDKUpdaterWorker\.js/.test(script);
            const isLegacy = /\/sw\.js$|wonderpush|workbox|vite-pwa/i.test(script);
            if (!isOneSignal && isLegacy) {
              console.warn('[SW Cleanup] Unregistering legacy worker:', { scope: r.scope, script });
              try { await r.unregister(); removed = true; }
              catch (e) { console.warn('[SW Cleanup] Unregister failed', e); }
            }
          }
          if (removed && !sessionStorage.getItem('swCleanupReloaded')) {
            console.log('[SW Cleanup] Reloading page to allow OneSignal worker to take control...');
            sessionStorage.setItem('swCleanupReloaded', '1');
            location.reload();
          }
        }).catch(e => console.warn('[SW Cleanup] getRegistrations failed', e));
      })();

      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        console.log('[OneSignal] Starting initialization...');
        
        await OneSignal.init({
          appId: "16ce973c-c7b3-42ff-b7b4-fe48be517186",
          serviceWorkerPath: "/OneSignalSDKWorker.js",
          serviceWorkerUpdaterPath: "/OneSignalSDKUpdaterWorker.js",
          allowLocalhostAsSecureOrigin: true,
        });
        
        console.log('[OneSignal] ‚úÖ Initialized successfully');
        
        // Log subscription status
        const isPushSupported = await OneSignal.Notifications.isPushSupported();
        console.log('[OneSignal] Push supported:', isPushSupported);
        
        const permission = await OneSignal.Notifications.permissionNative;
        console.log('[OneSignal] Current permission:', permission);
        
        // Display notifications in foreground (v16 API)
        OneSignal.Notifications.addEventListener('foregroundWillDisplay', (event) => {
          console.log('[OneSignal] üîî Notification received in foreground:', {
            title: event.notification.title,
            body: event.notification.body,
            additionalData: event.notification.additionalData
          });
          
          event.preventDefault();
          console.log('[OneSignal] Calling getNotification().display()...');
          
          // Correct v16 API - use getNotification()
          event.getNotification().display();
          
          console.log('[OneSignal] ‚úÖ Notification display() called');
        });
        
        // Log when notification is clicked
        OneSignal.Notifications.addEventListener('click', (event) => {
          console.log('[OneSignal] üëÜ Notification clicked:', event.notification);
        });
        
        // Log permission changes
        OneSignal.Notifications.addEventListener('permissionChange', (granted) => {
          console.log('[OneSignal] Permission changed to:', granted ? 'granted' : 'denied');
        });
        
        console.log('[OneSignal] All event listeners registered');
      });
    </script>
  </body>
</html>
